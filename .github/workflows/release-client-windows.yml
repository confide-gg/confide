name: Build Client (Windows)

on:
  workflow_call:
    inputs:
      tag_name:
        required: true
        type: string
    secrets:
      TAURI_SIGNING_PRIVATE_KEY:
        required: true
      TAURI_SIGNING_PRIVATE_KEY_PASSWORD:
        required: true

jobs:
  build-windows:
    name: Windows (x86_64)
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-pc-windows-msvc

      - name: Rust cache
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: client-windows-x86_64
          cache-targets: true
          cache-all-crates: true

      - name: Install system dependencies
        run: |
          choco install ffmpeg -y --no-progress
          choco install pkgconfiglite -y --no-progress
          choco install nasm -y --no-progress
          choco install llvm -y --no-progress

      - name: Set environment variables
        run: |
          $ffmpegPath = "C:\ProgramData\chocolatey\lib\ffmpeg\tools\ffmpeg"
          if (Test-Path $ffmpegPath) {
            echo "FFMPEG_DIR=$ffmpegPath" >> $env:GITHUB_ENV
          } else {
            # Try to find ffmpeg installation
            $ffmpegBin = (Get-Command ffmpeg -ErrorAction SilentlyContinue).Source
            if ($ffmpegBin) {
              $ffmpegDir = Split-Path (Split-Path $ffmpegBin -Parent) -Parent
              echo "FFMPEG_DIR=$ffmpegDir" >> $env:GITHUB_ENV
            }
          }
          
          $llvmPath = "C:\Program Files\LLVM"
          if (Test-Path $llvmPath) {
            echo "LIBCLANG_PATH=$llvmPath\bin" >> $env:GITHUB_ENV
          }

      - name: Install frontend dependencies
        working-directory: apps/client
        run: bun install --frozen-lockfile

      - name: Build Tauri app
        working-directory: apps/client
        run: bun run tauri build --target x86_64-pc-windows-msvc
        env:
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}

      - name: Prepare artifacts
        shell: pwsh
        run: |
          $BUNDLE = "target/x86_64-pc-windows-msvc/release/bundle"
          New-Item -ItemType Directory -Path artifacts -Force

          Write-Host "=== Bundle contents ==="
          Get-ChildItem $BUNDLE -Recurse | Select-Object FullName

          # Copy NSIS installer
          $nsisExe = Get-ChildItem "$BUNDLE/nsis/*.exe" -ErrorAction SilentlyContinue | Select-Object -First 1
          if ($nsisExe) {
            Copy-Item $nsisExe.FullName "artifacts/Confide-windows-x86_64.exe"
          }

          # Copy MSI installer if present
          $msiFile = Get-ChildItem "$BUNDLE/msi/*.msi" -ErrorAction SilentlyContinue | Select-Object -First 1
          if ($msiFile) {
            Copy-Item $msiFile.FullName "artifacts/Confide-windows-x86_64.msi"
          }

          # Copy updater artifacts
          $nsisZip = Get-ChildItem "$BUNDLE/nsis/*.nsis.zip" -ErrorAction SilentlyContinue | Select-Object -First 1
          if ($nsisZip) {
            Copy-Item $nsisZip.FullName "artifacts/"
            $sigFile = "$($nsisZip.FullName).sig"
            if (Test-Path $sigFile) {
              Copy-Item $sigFile "artifacts/"
              
              $FILENAME = $nsisZip.Name
              $SIGNATURE = Get-Content $sigFile -Raw
              $VERSION = "${{ inputs.tag_name }}" -replace '.*v', ''
              $URL = "https://github.com/${{ github.repository }}/releases/download/${{ inputs.tag_name }}/$FILENAME"
              
              $json = @{
                platform = "windows-x86_64"
                version = $VERSION
                signature = $SIGNATURE.Trim()
                url = $URL
              } | ConvertTo-Json -Compress
              
              $json | Out-File -FilePath "artifacts/update-windows-x86_64.json" -Encoding utf8
              Get-Content "artifacts/update-windows-x86_64.json"
            }
          }

          Write-Host "=== Final artifacts ==="
          Get-ChildItem artifacts

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: confide-windows
          path: artifacts/*
          if-no-files-found: error

name: Build Client (Windows)

on:
  workflow_call:
    inputs:
      tag_name:
        required: true
        type: string
    secrets:
      TAURI_SIGNING_PRIVATE_KEY:
        required: true
      TAURI_SIGNING_PRIVATE_KEY_PASSWORD:
        required: true

jobs:
  build-windows:
    name: Windows (x86_64)
    runs-on: windows-latest
    env:
      VCPKG_ROOT: ${{ github.workspace }}\vcpkg
      VCPKG_DEFAULT_TRIPLET: x64-windows
      VCPKG_BINARY_SOURCES: clear;files,${{ github.workspace }}\vcpkg-binary-cache,readwrite
      LIBCLANG_PATH: C:\Program Files\LLVM\bin
    steps:
      - uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-pc-windows-msvc

      - name: Rust cache
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: client-windows-x86_64
          cache-targets: true
          cache-all-crates: true

      - name: Cache vcpkg binaries
        uses: actions/cache@v4
        with:
          path: vcpkg-binary-cache
          key: vcpkg-${{ runner.os }}-${{ hashFiles('apps/client/src-tauri/Cargo.lock') }}
          restore-keys: |
            vcpkg-${{ runner.os }}-

      - name: Install system dependencies
        shell: pwsh
        run: |
          choco install -y llvm nasm nsis wixtoolset

      - name: Setup vcpkg
        uses: lukka/run-vcpkg@v11
        with:
          vcpkgDirectory: ${{ env.VCPKG_ROOT }}

      - name: Install vcpkg dependencies
        shell: pwsh
        run: |
          & "$env:VCPKG_ROOT\vcpkg.exe" install ffmpeg:x64-windows opus:x64-windows

      - name: Install frontend dependencies
        working-directory: apps/client
        run: bun install --frozen-lockfile

      - name: Build Tauri app
        working-directory: apps/client
        run: bun run tauri build --target x86_64-pc-windows-msvc
        env:
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}

      - name: Prepare artifacts
        shell: pwsh
        run: |
          $bundle = "target\x86_64-pc-windows-msvc\release\bundle"
          New-Item -ItemType Directory -Force -Path artifacts | Out-Null

          Get-ChildItem -Path $bundle -Recurse -File -Include *.msi | ForEach-Object { Copy-Item $_.FullName artifacts\ -Force }
          Get-ChildItem -Path $bundle -Recurse -File -Include *.exe | ForEach-Object { Copy-Item $_.FullName artifacts\ -Force }

          $updaterZip = Get-ChildItem -Path $bundle -Recurse -File -Filter *.zip | Where-Object { Test-Path "$($_.FullName).sig" } | Select-Object -First 1
          if ($null -ne $updaterZip) {
            Copy-Item $updaterZip.FullName artifacts\ -Force
            Copy-Item "$($updaterZip.FullName).sig" artifacts\ -Force

            $sig = Get-Content -Raw -Path "$($updaterZip.FullName).sig"
            $filename = Split-Path -Leaf $updaterZip.FullName
            $url = "https://github.com/${{ github.repository }}/releases/download/${{ inputs.tag_name }}/${filename}"
            $version = "${{ inputs.tag_name }}" -replace '.*v',''

            $obj = @{
              platform = "windows-x86_64"
              version = $version
              signature = $sig.Trim()
              url = $url
            } | ConvertTo-Json -Compress

            Set-Content -Path artifacts\update-windows-x86_64.json -Value $obj -NoNewline
          }

          Get-ChildItem -Path artifacts -Force

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: confide-windows
          path: artifacts/*
          if-no-files-found: error


name: Build Client (Windows)

on:
  workflow_call:
    inputs:
      tag_name:
        required: true
        type: string
    secrets:
      TAURI_SIGNING_PRIVATE_KEY:
        required: true
      TAURI_SIGNING_PRIVATE_KEY_PASSWORD:
        required: true

env:
  FFMPEG_VERSION: "7.1"

jobs:
  build-windows:
    name: Windows (x64)
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-pc-windows-msvc

      - name: Rust cache
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: client-windows-x64
          cache-targets: true
          cache-all-crates: true

      - name: Cache FFmpeg
        id: cache-ffmpeg
        uses: actions/cache@v4
        with:
          path: C:\ffmpeg
          key: ffmpeg-windows-${{ env.FFMPEG_VERSION }}-shared

      - name: Download and setup FFmpeg
        if: steps.cache-ffmpeg.outputs.cache-hit != 'true'
        shell: pwsh
        run: |
          $ffmpegUrl = "https://github.com/GyanD/codexffmpeg/releases/download/${{ env.FFMPEG_VERSION }}/ffmpeg-${{ env.FFMPEG_VERSION }}-full_build-shared.zip"
          Write-Host "Downloading FFmpeg from $ffmpegUrl"
          Invoke-WebRequest -Uri $ffmpegUrl -OutFile ffmpeg.zip
          Expand-Archive -Path ffmpeg.zip -DestinationPath C:\
          Rename-Item -Path "C:\ffmpeg-${{ env.FFMPEG_VERSION }}-full_build-shared" -NewName "C:\ffmpeg"

          Write-Host "FFmpeg installed to C:\ffmpeg"
          Get-ChildItem -Path "C:\ffmpeg" -Recurse -Depth 1

      - name: Setup FFmpeg environment
        shell: pwsh
        run: |
          echo "FFMPEG_DIR=C:\ffmpeg" >> $env:GITHUB_ENV
          echo "C:\ffmpeg\bin" >> $env:GITHUB_PATH

          Write-Host "FFmpeg libraries:"
          Get-ChildItem -Path "C:\ffmpeg\lib" -Filter "*.lib"

          Write-Host "FFmpeg binaries:"
          Get-ChildItem -Path "C:\ffmpeg\bin" -Filter "*.dll"

      - name: Install LLVM
        uses: KyleMayes/install-llvm-action@v2
        with:
          version: "18"

      - name: Setup pkg-config
        shell: pwsh
        run: |
          choco install pkgconfiglite -y

          $pkgConfigPath = "C:\ffmpeg\lib\pkgconfig"
          if (Test-Path $pkgConfigPath) {
            echo "PKG_CONFIG_PATH=$pkgConfigPath" >> $env:GITHUB_ENV
          }

      - name: Install frontend dependencies
        working-directory: apps/client
        run: bun install --frozen-lockfile

      - name: Build Tauri app
        working-directory: apps/client
        shell: pwsh
        run: bun run tauri build --target x86_64-pc-windows-msvc
        env:
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
          FFMPEG_DIR: C:\ffmpeg
          LIBCLANG_PATH: ${{ env.LLVM_PATH }}\lib

      - name: Prepare artifacts
        shell: pwsh
        run: |
          $bundle = "target\x86_64-pc-windows-msvc\release\bundle"
          New-Item -ItemType Directory -Force -Path artifacts

          Write-Host "=== Bundle contents ==="
          Get-ChildItem -Path $bundle -Recurse -Depth 2 | Format-Table Name, Length

          # Copy NSIS installer (preferred for Windows)
          $nsisPath = "$bundle\nsis"
          if (Test-Path $nsisPath) {
            Get-ChildItem -Path $nsisPath -Filter "*.exe" | ForEach-Object {
              Copy-Item $_.FullName -Destination "artifacts\Confide-windows-x64-setup.exe"
            }

            # Copy signature for updater
            Get-ChildItem -Path $nsisPath -Filter "*.nsis.zip" | ForEach-Object {
              Copy-Item $_.FullName -Destination "artifacts\"
            }
            Get-ChildItem -Path $nsisPath -Filter "*.nsis.zip.sig" | ForEach-Object {
              Copy-Item $_.FullName -Destination "artifacts\"
            }
          }

          # Copy MSI installer (WiX) as alternative
          $msiPath = "$bundle\msi"
          if (Test-Path $msiPath) {
            Get-ChildItem -Path $msiPath -Filter "*.msi" | ForEach-Object {
              Copy-Item $_.FullName -Destination "artifacts\Confide-windows-x64.msi"
            }
          }

          # Create updater JSON for NSIS bundle
          $nsisZip = Get-ChildItem -Path "artifacts" -Filter "*.nsis.zip" | Select-Object -First 1
          if ($nsisZip) {
            $sigFile = Get-ChildItem -Path "artifacts" -Filter "*.nsis.zip.sig" | Select-Object -First 1
            if ($sigFile) {
              $signature = Get-Content $sigFile.FullName -Raw
              $filename = $nsisZip.Name
              $version = "${{ inputs.tag_name }}" -replace '.*v', ''
              $url = "https://github.com/${{ github.repository }}/releases/download/${{ inputs.tag_name }}/$filename"

              $updateJson = @{
                platform = "windows-x86_64"
                version = $version
                signature = $signature.Trim()
                url = $url
              } | ConvertTo-Json -Compress

              Set-Content -Path "artifacts\update-windows-x86_64.json" -Value $updateJson
              Write-Host "=== update-windows-x86_64.json ==="
              Get-Content "artifacts\update-windows-x86_64.json"
            }
          }

          Write-Host "=== Final artifacts ==="
          Get-ChildItem -Path artifacts | Format-Table Name, Length

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: confide-windows
          path: artifacts/*
          if-no-files-found: error

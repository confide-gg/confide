name: Build Client (Ubuntu/Debian)

on:
  workflow_call:
    inputs:
      tag_name:
        required: true
        type: string
    secrets:
      TAURI_SIGNING_PRIVATE_KEY:
        required: true
      TAURI_SIGNING_PRIVATE_KEY_PASSWORD:
        required: true

jobs:
  build-ubuntu:
    name: Ubuntu/Debian (x86_64)
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-unknown-linux-gnu

      - name: Rust cache
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: client-linux-x86_64
          cache-targets: true
          cache-all-crates: true

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libgtk-3-dev \
            libwebkit2gtk-4.1-dev \
            libayatana-appindicator3-dev \
            librsvg2-dev \
            patchelf \
            libasound2-dev \
            libssl-dev \
            libxdo-dev \
            libxcb1-dev \
            libxrandr-dev \
            libx11-dev \
            libxcb-shape0-dev \
            libxcb-xfixes0-dev \
            libpipewire-0.3-dev \
            libspa-0.2-dev \
            libnotify-dev \
            libopus-dev \
            libclang-dev \
            clang \
            nasm \
            ffmpeg \
            libavcodec-dev \
            libavformat-dev \
            libavutil-dev \
            libswscale-dev \
            libavfilter-dev \
            libavdevice-dev \
            libswresample-dev

      - name: Install frontend dependencies
        working-directory: apps/client
        run: bun install --frozen-lockfile

      - name: Build Tauri app
        working-directory: apps/client
        run: bun run tauri build --target x86_64-unknown-linux-gnu
        env:
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}

      - name: Prepare artifacts
        run: |
          BUNDLE=target/x86_64-unknown-linux-gnu/release/bundle
          mkdir -p artifacts

          echo "=== Bundle contents ==="
          ls -la $BUNDLE/
          ls -la $BUNDLE/appimage/ || true
          ls -la $BUNDLE/deb/ || true

          cp $BUNDLE/appimage/*.AppImage artifacts/Confide-linux-x86_64.AppImage || true
          cp $BUNDLE/deb/*.deb artifacts/Confide-linux-x86_64.deb || true

          if ls $BUNDLE/appimage/*.tar.gz 1> /dev/null 2>&1; then
            cp $BUNDLE/appimage/*.tar.gz artifacts/
            cp $BUNDLE/appimage/*.tar.gz.sig artifacts/

            FILENAME=$(basename $(ls $BUNDLE/appimage/*.tar.gz | head -1))
            SIGNATURE=$(cat $BUNDLE/appimage/*.tar.gz.sig)
            URL="https://github.com/${{ github.repository }}/releases/download/${{ inputs.tag_name }}/${FILENAME}"
            VERSION=$(echo "${{ inputs.tag_name }}" | sed 's/.*v//')

            echo "{\"platform\":\"linux-x86_64\",\"version\":\"${VERSION}\",\"signature\":\"${SIGNATURE}\",\"url\":\"${URL}\"}" > artifacts/update-linux-x86_64.json
            cat artifacts/update-linux-x86_64.json
          else
            echo "WARNING: No updater artifacts found"
          fi

          echo "=== Final artifacts ==="
          ls -la artifacts/

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: confide-ubuntu
          path: artifacts/*
          if-no-files-found: error

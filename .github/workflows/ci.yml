name: CI

on:
  pull_request:
    branches: [main, develop]
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.gitignore'
      - 'LICENSE'
      - '.github/**'
      - 'CHANGELOG.md'
      - '.release-please-manifest.json'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  CARGO_TERM_COLOR: always

jobs:
  changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read
    outputs:
      rust: ${{ steps.filter.outputs.rust }}
      central: ${{ steps.filter.outputs.central }}
      server: ${{ steps.filter.outputs.server }}
      client: ${{ steps.filter.outputs.client }}
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
      - uses: dorny/paths-filter@de90cc6fb38fc0963ad72b210f1f284cd68cea36 # v3.0.2
        id: filter
        with:
          filters: |
            rust:
              - 'apps/central/**'
              - 'apps/server/**'
              - 'Cargo.toml'
              - 'Cargo.lock'
            central:
              - 'apps/central/**'
              - 'Cargo.toml'
              - 'Cargo.lock'
              - 'infrastructure/docker/Dockerfile.central'
            server:
              - 'apps/server/**'
              - 'Cargo.toml'
              - 'Cargo.lock'
              - 'infrastructure/docker/Dockerfile.server'
            client:
              - 'apps/client/**'
              - 'crates/**'
              - 'Cargo.toml'
              - 'Cargo.lock'

  rust-fmt:
    name: Rust Format
    needs: changes
    if: needs.changes.outputs.rust == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt
      - run: cargo fmt --all -- --check

  rust-clippy:
    name: Rust Clippy
    needs: changes
    if: needs.changes.outputs.rust == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy
      - uses: Swatinem/rust-cache@779680da715d629ac1d338a641029a2f4372abb5 # v2.8.2
      - run: cargo clippy --package confide-central --package confide-server --all-targets --all-features -- -D warnings

  rust-test:
    name: Rust Test (${{ matrix.package }})
    needs: changes
    runs-on: ubuntu-latest
    permissions:
      contents: read
    if: needs.changes.outputs.central == 'true' || needs.changes.outputs.server == 'true'
    strategy:
      matrix:
        package:
          - confide-central
          - confide-server
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Cache APT packages
        uses: actions/cache@5a3ec84eff668545956fd18022155c47e93e2684 # v4.2.3
        with:
          path: |
            /var/cache/apt/archives
            /var/lib/apt/lists
          key: ${{ runner.os }}-apt-test-${{ hashFiles('.github/workflows/ci.yml') }}
          restore-keys: |
            ${{ runner.os }}-apt-test-
            ${{ runner.os }}-apt-

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libglib2.0-dev

      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@779680da715d629ac1d338a641029a2f4372abb5 # v2.8.2
        with:
          key: ${{ matrix.package }}
      - run: cargo test --package ${{ matrix.package }} --all-features

  client-build-windows:
    name: Client Build (Windows)
    needs: changes
    if: needs.changes.outputs.client == 'true'
    runs-on: windows-latest
    permissions:
      contents: read
    env:
      FFMPEG_VERSION: "7.1"
      FFMPEG_SHA256: "db85c58e7522b66ec2c61749803e0f7f6c6e0b1a07bb2c04055e01fdf3dbae23"
    steps:
      - uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-pc-windows-msvc

      - name: Rust cache
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: client-windows-x64-ci
          cache-targets: true
          cache-all-crates: true

      - name: Cache FFmpeg
        id: cache-ffmpeg
        uses: actions/cache@v4
        with:
          path: C:\ffmpeg
          key: ffmpeg-windows-${{ env.FFMPEG_VERSION }}-shared-v2

      - name: Download and setup FFmpeg
        if: steps.cache-ffmpeg.outputs.cache-hit != 'true'
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"

          $ffmpegUrl = "https://github.com/GyanD/codexffmpeg/releases/download/${{ env.FFMPEG_VERSION }}/ffmpeg-${{ env.FFMPEG_VERSION }}-full_build-shared.zip"
          Write-Host "Downloading FFmpeg from $ffmpegUrl"
          Invoke-WebRequest -Uri $ffmpegUrl -OutFile ffmpeg.zip

          Write-Host "Verifying checksum..."
          $hash = (Get-FileHash -Path ffmpeg.zip -Algorithm SHA256).Hash.ToLower()
          $expected = "${{ env.FFMPEG_SHA256 }}"
          if ($hash -ne $expected) {
            Write-Error "Checksum mismatch! Expected: $expected, Got: $hash"
            exit 1
          }
          Write-Host "Checksum verified: $hash"

          Write-Host "Extracting FFmpeg..."
          Expand-Archive -Path ffmpeg.zip -DestinationPath C:\
          Move-Item -Path "C:\ffmpeg-${{ env.FFMPEG_VERSION }}-full_build-shared" -Destination "C:\ffmpeg"

          if (-not (Test-Path "C:\ffmpeg\bin\ffmpeg.exe")) {
            Write-Error "FFmpeg installation failed"
            exit 1
          }
          Write-Host "FFmpeg installed successfully"

      - name: Verify FFmpeg installation
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          if (-not (Test-Path "C:\ffmpeg\bin\ffmpeg.exe")) {
            Write-Error "FFmpeg not found"
            exit 1
          }
          echo "FFMPEG_DIR=C:\ffmpeg" >> $env:GITHUB_ENV
          echo "C:\ffmpeg\bin" >> $env:GITHUB_PATH

      - name: Install LLVM
        uses: KyleMayes/install-llvm-action@v2
        with:
          version: "18"

      - name: Setup pkg-config
        shell: pwsh
        run: choco install pkgconfiglite -y

      - name: Install frontend dependencies
        working-directory: apps/client
        run: bun install --frozen-lockfile

      - name: Build frontend
        working-directory: apps/client
        run: bun run build

      - name: Build Rust
        working-directory: apps/client/src-tauri
        shell: pwsh
        run: cargo build --target x86_64-pc-windows-msvc
        env:
          FFMPEG_DIR: C:\ffmpeg
          LIBCLANG_PATH: ${{ env.LLVM_PATH }}\lib

  client-build-macos:
    name: Client Build (macOS)
    needs: changes
    if: needs.changes.outputs.client == 'true'
    runs-on: macos-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-apple-darwin

      - name: Rust cache
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: client-macos-aarch64-ci
          cache-targets: true
          cache-all-crates: true

      - name: Cache Homebrew packages
        uses: actions/cache@v4
        with:
          path: |
            ~/Library/Caches/Homebrew
            /opt/homebrew/Cellar/ffmpeg
            /opt/homebrew/Cellar/pkg-config
            /opt/homebrew/Cellar/opus
          key: macos-brew-ci-${{ hashFiles('.github/workflows/ci.yml') }}
          restore-keys: macos-brew-ci-

      - name: Install system dependencies
        env:
          HOMEBREW_NO_AUTO_UPDATE: 1
        run: |
          brew install ffmpeg pkg-config opus
          brew link ffmpeg pkg-config opus

      - name: Install frontend dependencies
        working-directory: apps/client
        run: bun install --frozen-lockfile

      - name: Build frontend
        working-directory: apps/client
        run: bun run build

      - name: Build Rust
        working-directory: apps/client/src-tauri
        run: cargo build --target aarch64-apple-darwin

name: Build Client (macOS)

on:
  workflow_call:
    inputs:
      tag_name:
        required: true
        type: string
    secrets:
      TAURI_SIGNING_PRIVATE_KEY:
        required: true
      TAURI_SIGNING_PRIVATE_KEY_PASSWORD:
        required: true

jobs:
  build-macos:
    name: macOS (Apple Silicon)
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-apple-darwin

      - name: Rust cache
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: client-macos-aarch64
          cache-targets: true
          cache-all-crates: true

      - name: Cache Homebrew packages
        uses: actions/cache@v4
        with:
          path: |
            ~/Library/Caches/Homebrew
            /opt/homebrew/Cellar/ffmpeg
            /opt/homebrew/Cellar/pkg-config
            /opt/homebrew/Cellar/opus
          key: macos-brew-${{ hashFiles('.github/workflows/release-client-macos.yml') }}
          restore-keys: macos-brew-

      - name: Install system dependencies
        env:
          HOMEBREW_NO_AUTO_UPDATE: 1
        run: |
          brew install ffmpeg pkg-config opus
          brew link ffmpeg pkg-config opus

      - name: Install frontend dependencies
        working-directory: apps/client
        run: bun install --frozen-lockfile

      - name: Build Tauri app
        working-directory: apps/client
        run: bun run tauri build --target aarch64-apple-darwin
        env:
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}

      - name: Prepare artifacts
        run: |
          BUNDLE=target/aarch64-apple-darwin/release/bundle
          mkdir -p artifacts

          echo "=== Bundle contents ==="
          ls -la $BUNDLE/
          ls -la $BUNDLE/macos/ || true
          ls -la $BUNDLE/dmg/ || true

          cp $BUNDLE/dmg/*.dmg artifacts/Confide-macos-aarch64.dmg

          if ls $BUNDLE/macos/*.tar.gz 1> /dev/null 2>&1; then
            cp $BUNDLE/macos/*.tar.gz artifacts/
            cp $BUNDLE/macos/*.tar.gz.sig artifacts/

            FILENAME=$(basename $(ls $BUNDLE/macos/*.tar.gz | head -1))
            SIGNATURE=$(cat $BUNDLE/macos/*.tar.gz.sig)
            URL="https://github.com/${{ github.repository }}/releases/download/${{ inputs.tag_name }}/${FILENAME}"
            VERSION=$(echo "${{ inputs.tag_name }}" | sed 's/.*v//')

            echo "{\"platform\":\"darwin-aarch64\",\"version\":\"${VERSION}\",\"signature\":\"${SIGNATURE}\",\"url\":\"${URL}\"}" > artifacts/update-darwin-aarch64.json
            cat artifacts/update-darwin-aarch64.json
          else
            echo "WARNING: No updater artifacts found"
          fi

          echo "=== Final artifacts ==="
          ls -la artifacts/

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: confide-macos
          path: artifacts/*
          if-no-files-found: error
